\subsection{Quadcopter}

\begin{figure}[ht]
 \centering
% \def\svgwidth{.5\textwidth}
 \input{graphics/QuadMechModel.pdf_tex}
 \caption{Model of the Quadcopter}
 \label{fig:QuadModel}
\end{figure}

\paragraph{Model.}
Mechanically, a quadcopter is a free 3d rigid body subject to gravity and the specific actuation as illustrated in \autoref{fig:QuadModel}.
It is reasonable to chose the center of mass as the reference point and assume that the body frame coincides with the priciple axes of inertia.
%\begin{align}\label{eq:QuadcopterKinematics}
% \rd = \R\v, \quad \Rd = \R\wedOp(\w)
%\end{align}
Then the kinetic equation takes the form
\begin{align}\label{eq:QuadcopterKinetics}
 \underbrace{\!\begin{bmatrix}
  m & 0 & 0 & 0 & 0 & 0 \\
  0 & m & 0 & 0 & 0 & 0 \\
  0 & 0 & m & 0 & 0 & 0 \\
  0 & 0 & 0 & \!\Jy\! & 0 & 0 \\
  0 & 0 & 0 & 0 & \!\Jx\! & 0 \\
  0 & 0 & 0 & 0 & 0 & \!\Jz\! \\
  \end{bmatrix}\!}_{\sysInertiaMat}
 \underbrace{\!\begin{bmatrix} \vxd \\ \vyd \\ \vzd \\ \wxd \\ \wyd \\ \wzd \end{bmatrix}\!}_{\sysVeld}
 +
 \underbrace{\!\begin{bmatrix}
  m (\vy\wz \!-\! \vz\wy + \Rzx\gravityAccConst) \\
  m (\vx\wz \!-\! \vz\wx + \Rzy\gravityAccConst) \\
  m (\vy\wx \!-\! \vx\wy + \Rzz\gravityAccConst) \\
  (\Jz-\Jy)\wy\wz \\
  (\Jx-\Jz)\wx\wz \\
  (\Jy-\Jx)\wx\wy \\
 \end{bmatrix}\!}_{\sysForce}
 =
 \underbrace{\!\begin{bmatrix}
  0 & 0 & 0 & 0 \\
  0 & 0 & 0 & 0 \\
  1 & 1 & 1 & 1 \\
  0 & \ArmRadius & 0 & -\ArmRadius \\
  -\ArmRadius & 0 & \ArmRadius & 0 \\
  -\PropTorqueFaktor & \PropTorqueFaktor & -\PropTorqueFaktor & \PropTorqueFaktor \\
 \end{bmatrix}\!}_{\sysInputMat}
 \underbrace{\!\begin{bmatrix} \PropForce[1] \\ \PropForce[2] \\ \PropForce[3] \\ \PropForce[4] \end{bmatrix}\!}_{\sysInput}
\end{align}

\paragraph{Reference trajectory.}
An obvious left complement for $\sysInputMat$ is
\begin{align}
 (\sysInputMatLComp)^\top = \begin{bmatrix} 1 & 0 & 0 & 0 & 0 & 0 \\ 0 & 1 & 0 & 0 & 0 & 0 \end{bmatrix}.
\end{align}
With this, the matiching condition for the reference from \eqref{eq:MatchingForceZeroError} are just the two first equations of \eqref{eq:QuadcopterKinetics}:
\begin{align}
 \tuple{\lambda}^{\text{ZeroError}} = m \begin{bmatrix} \vxRd + \vzR\wyR-\vyR\wzR + \RRzx\gravityAccConst \\ \vyRd + \vxR\wzR-\vzR\wxR + \RRzy \gravityAccConst \end{bmatrix} = \tuple{0}
 .
\end{align}
This may be easily resolved by formulating the reference trajectory in terms of the systems flat output $\r$ and some parameterization of the orientation about the body fixed z-axis as done in \cite{Konz:QuadrotorMovingFrame}.

\paragraph{Closed loop template.}
As the quadcopter is just a free rigid body with a particular actuation, the closed loop templates coincide with the ones given in \autoref{sec:CtrlApproachParticlesSingleBody}, \autoref{sec:CtrlApproachBodySingleBody} and \autoref{sec:CtrlApproachEnergySingleBody}.
Due to symmetry considerations we set $\scx = \scy = 0$, $\Jcxx=\Jcyy$, $\Jcxy=\Jcxz=\Jcyz=0$ and analog for the stiffness and damping parameters.

\paragraph{Matching.}
The explicit matching conditions are too cumbersome to be displayed here.
Instead we start again with the linearized version:
The linearized system matrices for model and closed loop template are
\begin{align*}
 \sysInertiaMatLin &= 
 \begin{bmatrix}
  m & 0 & 0 & 0 & 0 & 0 \\
  0 & m & 0 & 0 & 0 & 0 \\
  0 & 0 & m & 0 & 0 & 0 \\
  0 & 0 & 0 & \!\Jy\! & 0 & 0 \\
  0 & 0 & 0 & 0 & \!\Jx\! & 0 \\
  0 & 0 & 0 & 0 & 0 & \!\Jz\! \\
  \end{bmatrix},&
 \sysInertiaMatCLin &=
 \begin{bmatrix}
  \mc & 0 & 0 & 0 & \mc\scz & 0 \\
  0 & \mc & 0 & -\mc\scz & 0 & 0 \\
  0 & 0 & \mc & 0 & 0 & 0 \\
  0 & -\mc\scz & 0 & \!\Jcx+\mc\scz^2\! & 0 & 0 \\
  \mc\scz & 0 & 0 & 0 & \!\Jcx+\mc\scz^2\! & 0 \\
  0 & 0 & 0 & 0 & 0 & \!\Jcz\! \\
 \end{bmatrix},
\\
 \sysDissMatLin &= 
 \begin{bmatrix}
  0 & 0 & 0 & 0 & 0 & 0 \\
  0 & 0 & 0 & 0 & 0 & 0 \\
  0 & 0 & 0 & 0 & 0 & 0 \\
  0 & 0 & 0 & 0 & 0 & 0 \\
  0 & 0 & 0 & 0 & 0 & 0 \\
  0 & 0 & 0 & 0 & 0 & 0 \\
  \end{bmatrix},&
 \sysDissMatCLin &=
 \begin{bmatrix}
  \dc & 0 & 0 & 0 & \dc\lcz & 0 \\
  0 & \dc & 0 & -\dc\lcz & 0 & 0 \\
  0 & 0 & \dc & 0 & 0 & 0 \\
  0 & -\dc\lcz & 0 & \!\sigcx+\dc\lcz^2\! & 0 & 0 \\
  \dc\lcz & 0 & 0 & 0 & \!\sigcx+\dc\lcz^2\! & 0 \\
  0 & 0 & 0 & 0 & 0 & \!\sigcz\! \\
 \end{bmatrix},
\\ 
 \sysStiffMatLin &= 
 \begin{bmatrix}
  0 & 0 & 0 & 0 & -m\gravityAccConst & 0 \\
  0 & 0 & 0 & m\gravityAccConst & 0 & 0 \\
  0 & 0 & 0 & 0 & 0 & 0 \\
  0 & 0 & 0 & 0 & 0 & 0 \\
  0 & 0 & 0 & 0 & 0 & 0 \\
  0 & 0 & 0 & 0 & 0 & 0 \\
  \end{bmatrix},&
 \sysStiffMatCLin &=
 \begin{bmatrix}
  \kc & 0 & 0 & 0 & \kc\hcz & 0 \\
  0 & \kc & 0 & -\kc\hcz & 0 & 0 \\
  0 & 0 & \kc & 0 & 0 & 0 \\
  0 & -\kc\hcz & 0 & \!\kapcx+\kc\hcz^2\! & 0 & 0 \\
  \kc\hcz & 0 & 0 & 0 & \!\kapcx+\kc\hcz^2\! & 0 \\
  0 & 0 & 0 & 0 & 0 & \!\kapcz\! \\
 \end{bmatrix}.
\end{align*}
Taking into account the symmetries between x and y directions, the remaining linearized matching conditions are
\begin{subequations}
\begin{align}
 \kc(\Jcx - \mc\scz(\hcz - \scz)) &= 0
%\\
% \kc(\Jcy - \mc\scz(\hcz -\scz)) &= 0
\\
 \mc(\Jcx\gravityAccConst - \kapcx\scz) + \kc\hcz(\Jcx - \mc\scz(\hcz - \scz)) &= 0
%\\
% \mc(\Jcy\gravityAccConst - \kapcy\scz) + \kc\hcz(\Jcy - \mc\scz(\hcz - \scz)) &= 0
\\
 \dc(\Jcx - \mc\scz(\hcz - \scz)) &= 0
%\\
% \dc(\Jcy - \mc\scz(\hcz -\scz)) &= 0
\\
 -\mc\scz\sigcx + \dc\lcz(\Jcx - \mc\scz(\lcz - \scz)) &= 0
%\\
% -\mc\scz\sigcy + \dc\lcz(\Jcy - \mc\scz(\lcz - \scz)) &= 0
\end{align} 
\end{subequations}
It is not surprising that these are identical to the previously encountered conditions \eqref{eq:PVTOLMatchingCondLin} for the PVTOL for $\eps=0$.
Consequently we use the same solution
\begin{align}
 \lcz &= \hcz,&
 \Jcx = \Jcy &= \mc\scz(\hcz \!-\! \scz),&
 \sigcx = \sigcy &= 0,&
 \kapcx = \kapcy &= \mc\gravityAccConst(\hcz \!-\! \scz).
\end{align}
which leaves the tuning parameters $\mc, \dc, \kc, \scz, \hcz$ and $\Jcz, \sigcz, \kapcz$.

Even with the linearized matching condtions fulfilled, the nonlinear matching condition is still to cumbersome to be displayed here.
For the case of a constant reference velocity $\vRd = \tuple{0}$ and its implications on the reference attitude, $\wRx=\wRy=0$, we have the residual matching force
\begin{align} 
 \tilde{\sysForce} = \frac{\mc}{\m\hcz}\begin{bmatrix} \Jcz\wx\wz - \tfrac{1}{2}\kapcz(\RExz+\REzx) \\ \Jcz\wy\wz - \tfrac{1}{2}\kapcz(\REyz+\REzy) \\ 0 \\ 0 \\ 0 \\ 0 \end{bmatrix}
 .
\end{align}

\paragraph{Tuning.}
The first set of parameters $\mc, \dc, \kc, \scz, \hcz$ may be tuned just as presented for the PVTOL, see \autoref{fig:PVTOLPendulum}.
The parameters accociated with the heading control may be set to $\sigcz=2\Jcz\zeta\omega_0$ and $\kapcz=\Jcz\omega_0^2$ to obtain a desired bandwidth $\omega_0$ and damping ratio $\zeta$.
The corresponding moment of inertia $\Jcz > 0$ may be adjusted in relation to $\Jcx$ as a priority factor between heading control and tilt control.
This is most crucial if the quatcopter propellers are at their constraints and the control has to find a trade-off between maintaining its tilt (and consequently its position), or the heading.
For most applications heading is less important than tilt so one may set $\Jcz = 0.1\,\Jcx$ as was done for the experiments with the LSR quadcopter presented in the next section.


\paragraph{Simulation results.}
The body based approach proposed here was also discussed in \cite{Konz:GaussTrackingControl} which also showed simulation results for a looping trajectory.
Furthermore, this approch was implemented for the experimental setup in the LSR quadcopter.
The results are discussed in detail in the next chapter.
