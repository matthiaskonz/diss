\section{Multicopter Models}\label{sec:RealizationModels}
This section derives a mathematical model for a multicopter based on the theory and the example from \autoref{sec:RBSRigidBodySys}.
Furthermore, it covers parameter identification, model simplifications and validation with the LSR quad and tricopter.
The resulting models are the basis for simulation and controller design. 

\subsection{Actuator models}

\paragraph{Propeller motor.}
A multicopter propeller is mounted on a small brushless DC motor (BLDC) which is controlled by dedicated driver electronics.
This driver implements the electronic commutation and a digital current control with sampling frequency of $64\,\unit{kHz}$.
It receives the desired, torque generating current $\BLDCCurr$ from the main controller with the sampling frequency of $200\,\unit{Hz}$. 
Consequently we assume that all electrical dynamics of the propeller drive are negligible on the timescale of the main controller and the motor torque on the propeller is proportional to its current as
\begin{align}
 \BLDCTorque = \BLDCTorqueConstant \BLDCCurr.
\end{align}

\paragraph{Servo motor.}
On the tricopter there are servo motors controlling the tilt $\aServo$ of the propellers.
These are standard hobbyist servos which combine a small motor, a gearbox, a potentiometer and some digital controller which takes the desired servo angle $\aServoR$ as input.
The integrated controller is probably a fast PID controller since it handles constant loads as well as fast transitions quite well.
However, at the main controller sampling frequency, $200\,\unit{Hz}$, the fast internal dynamics are negligible and for modeling we only assume a PD controller
\begin{align}
 \ServoTorque = \ServoKP (\aServoR - \aServo) - \ServoKD \aServod.
\end{align}
Comparison of the resulting model and actual measurements in \autoref{fig:ServoSimRes}, show that this assumption is valid here.

\paragraph{Propeller aerodynamics.}
Propellers are designed to generate a force in its spinning direction.
A general theory of propellers is quite sophisticated, see e.g.\ \cite{Johnson:HelicopterTheory}.
However, for the small, rigid propellers used on the LSR quad and tricopter a simple model, which is also common in the corresponding literature e.g.\ \cite{Mahony:Quadrotor2002}, \cite{MellingerIJRR12} or \cite{Fritsch:Diss}, is sufficient:
\begin{align}\label{eq:RealizationModelPropeller}
 \PropForce = \kappaF \PropVel^2,
\qquad
 \PropTorque = -\kappaT \PropVel^2.
\end{align}
where $\PropVel$ is the angular velocity of the propeller.
The propeller thrust $\PropForce$ is directed along its spinning direction and the propeller drag $\PropTorque$ acts opposing the spinning direction.
The model parameters $\kappaF$ and $\kappaT$ arise from the propeller geometry but will be identified in dedicated experiments.

In \cite{Bristeau:Propeller} and \cite{Martin:AccelerometerFeedback} a more sophisticated aerodynamic model for a quadcopter of about the same size as the one used here is proposed.
It mainly adds dissipative forces that are bilinear in the propeller velocities $\PropVel$ and the rigid body velocities $\v$ and $\w$.
For this it introduces 8 additional constant model parameters.
Even though their model has a nice physical motivation, it does not fit to the experimental observations done for this work.
It does, however, motivate linear drag force and torques on the multicopter body.

\paragraph{Dissipative forces.}
We assume a general linear damping model for the overall multicopter as motivated in \autoref{sec:DampingSE3}
\begin{align}
 \begin{bmatrix} \tuple{\bodyForceSym}_D \\ \tuple{\bodyTorqueSym}_D \end{bmatrix}
 &= 
 \begin{bmatrix} \mat{D}_v & \mat{D}_v \wedOp(\bodyCOD{}{})^\top \\ \wedOp(\bodyCOD{}{}) \mat{D}_v & \bodyMOD{}{} \end{bmatrix}
 \begin{bmatrix} \v \\ \w \end{bmatrix}
\end{align}
where the parameters $\mat{D}_v = \diag(\dvx, \dvx, \dvz)$, $\bodyCOD{}{}{} = [0,0,\lz]^\top$, $\bodyMOD{}{}{} = \diag(\sigx, \sigx, \sigz)$ reflect the geometric symmetries of the multicopters.


\subsection{Rigid body model}
A rigid body model for a tricopter with tiltable propellers has been discussed in \autoref{sec:RBSRigidBodySys}.
Here we like to present a generic model for a multicopter with $\numProp$ tiltable propellers.
The specific model for a quadcopter and a tricopter arises by application of special parameter values.

\paragraph{Coordinates and Kinematics.}
Recalling from \autoref{sec:RBSRigidBodySys}, we choose the configuration coordinates 
\begin{align}
 \sysCoord = \big[ \r^\top, \vectorize(\R)^\top, \tuple{\PropTilt}^\top, \tuple{\PropAngle}^\top \big]^\top \in \RealNum^{12+2\numProp}
\end{align}
where $\r \in \RealNum^3$ is the position of the center body, $\R \in \SpecialOrthogonalGroup(3)$ its orientation matrix, $\tuple{\PropTilt} = [\PropTilt[1], \ldots, \PropTilt[\numProp]]^\top \in \RealNum^{\numProp}$ the arm tilt angles and $\tuple{\PropAngle} = [\PropAngle[1],\ldots,\PropAngle[\numProp]]^\top \in \RealNum^{\numProp}$ the angles of the propellers, see \autoref{fig:TricopterInputs}.
Note that the propellers are designed only for either clockwise or counter-clockwise rotation, and will only rotate in this direction during operation.
The propeller angles $\PropAngle[k]$ are defined, such that $\PropAngled[k] > 0$ during operation.
To recover the spinning directions we use the parameter $\PropDir[k] = 1$ for a positive/counter-clockwise and $\PropDir[k] = -1$ for a negative/clockwise spinning propeller.

\begin{figure}
 \centering
 \input{graphics/TricopterInputs.pdf_tex}
 \caption{Mechanical model of the tricopter}
 \label{fig:TricopterInputs}
\end{figure}

To capture the velocity state of the system we use the velocity coordinates
\begin{align}
 \sysVel = \big[ \v, \w, \dot{\tuple{\PropTilt}}, \tuple{\PropVel}]^\top \in \RealNum^{6+2\numProp},
\end{align}
related to the configuration coordinates by
\begin{align}
 \rd = \R \v, 
\qquad
 \Rd = \R \wedOp(\w),
\qquad
 \dot{\tuple{\PropAngle}} = \tuple{\PropVel}.
\end{align}

\paragraph{Assumtions on the mass distribution.}
The algorithm proposed in \autoref{sec:RBSRigidBodySys} does of course handle general mass distributions of the rigid bodies, but the resulting kinetic equations are far too cumbersome to display here explicitly.
Instead we motivate some assumptions on the body inertia matrices that will lead to a greatly condensed system inertia matrix:
Assume that the combined center of mass of one arms and its propeller lies on the tilt axis.
This implies that the overall center of mass $\bodyCOM{}{}{} \in \RealNum^{3}$ of the complete system is constant w.r.t.\ the body fixed frame.
This was one goal during the construction process of the Tricopter.
Furthermore, we assume that the combined moment of inertia of one arm and propeller is symmetric about the tilt axis.
This is not the case for the real inertia parameters.
However, it is justified by the fact that the overall inertia $\bodyMOI{}{}{}$ changes only slightly depending on the arm tilts $\PropTilt$ or the propeller angles $\PropAngle$.  

A crucial part to get the overall dynamics right, is to explicitly consider the rotor of the servo motor.
The relevant moment of inertia $\bodyMOISym_{\textsf{Sxx}}$ might be very small, but since it is located behind a gearbox with transmission ratio $c_{\mathsf{S}} = 625$ its contribution to the system inertia matrix is significant.
This is reflected in the different values within $\JAC$ which contains $c_{\mathsf{S}} \bodyMOISym_{\textsf{Sxx}}$ and $\JA$ which contains $c_{\mathsf{S}}^2 \bodyMOISym_{\textsf{Sxx}}$.
The validity of the model with these assumptions will be discussed later by comparison to experimental data.

\paragraph{Kinetic equation.}
With the above assumptions, and the propeller model \eqref{eq:RealizationModelPropeller}, the kinetic equation for a multicopter takes the form
\begin{align}\label{eq:RealizationMulticopterKinetics}
 \sysInertiaMat(\tuple{\PropTilt}) \sysVeld + \gyroForce(\tuple{\PropTilt}, \sysVel) + \sysDissMat \sysVel + \genForceGravity(\R) &= \genForceProp(\tuple{\PropTilt}, \PropVel) + \genForceInput(\BLDCTorque, \ServoTorque) + \genForceBias
\end{align}
where
\begin{subequations}\label{eq:RealizationMulticopterForces}
\allowdisplaybreaks
\begin{align}
 \sysInertiaMat(\tuple{\PropTilt}) &=
 \begin{bmatrix}[1.1]
  \m \idMat[3] & \m \wedOp(\bodyCOM{}{})^\top & 0 & 0 \\
  \m \wedOp(\bodyCOM{}{}) & \bodyMOI{}{}{} & \JAC \mat{H}_1 & \JP \mat{H}_3(\tuple{\PropTilt}) \diag(\tuple{\PropDir}) \\
  0 & \JAC \mat{H}_1^\top & \ArmInertia \idMat[\numProp] & 0 \\
  0 & \JP \diag(\tuple{\PropDir}) \mat{H}_3^\top(\tuple{\PropTilt}) & 0 & \PropInertia \idMat[\numProp]
 \end{bmatrix},
\\
 \gyroForce(\tuple{\PropTilt}, \sysVel) &= 
 \begin{bmatrix}[1.1]
  \wedOp(\w) \tuple{\genMomentumSym}_{\v} \\
  \wedOp(\v) \tuple{\genMomentumSym}_{\v} + \wedOp(\w) \tuple{\genMomentumSym}_{\w} + \JP \mat{H}_4(\tuple{\PropTilt}) \diag(\dot{\tuple{\PropTilt}}) \diag(\tuple{\PropDir}) \tuple{\PropVel} \\
  -\JP \diag( \diag(\tuple{\PropDir}) \mat{H}_4^\top(\tuple{\PropTilt}) \w) \tuple{\PropVel} \\
   \JP \diag( \diag(\tuple{\PropDir}) \mat{H}_4^\top(\tuple{\PropTilt}) \w) \dot{\tuple{\PropTilt}} \\
 \end{bmatrix},
\\
 \sysDissMat &= \begin{bmatrix} \mat{D}_v & \mat{D}_v \!\wedOp(\bodyCOD{}{})^\top\! & 0 & 0 \\ \wedOp(\bodyCOD{}{}) \mat{D}_v & \bodyMOD{}{}{} & 0 & 0 \\ 0 & 0 & 0 & 0 \\ 0 & 0 & 0 & 0 \end{bmatrix}\!,
\quad
 \genForceGravity(\R) = \begin{bmatrix}[1.1] \m \idMat[3] \\ \m \wedOp(\bodyCOM{}{}) \\ 0 \\ 0 \end{bmatrix} \RT (-\gravityAcc),
\\
 \genForceProp(\tuple{\PropTilt}, \tuple{\PropVel}) &= \begin{bmatrix} \kappaF \mat{H}_3(\tuple{\PropTilt}) \\ \kappaF \big( \ArmRadius \mat{H}_4(\tuple{\PropTilt}) + \ArmHeight \mat{H}_2(\tuple{\PropTilt}) \big) - \kappaT \mat{H}_3(\tuple{\PropTilt}) \diag(\tuple{\PropDir}) \\ 0 \\ -\kappaT \idMat[\numProp] \end{bmatrix} \diag(\tuple{\PropVel}) \tuple{\PropVel},
\\
 \genForceInput(\BLDCTorque, \ServoTorque) &= \begin{bmatrix} 0 \\ 0 \\ \ServoTorque \\ \BLDCTorque \end{bmatrix}
\qquad
 \genForceBias = \begin{bmatrix} \FB \\ \tauB \\ 0 \\ \BLDCFriction \end{bmatrix}
\end{align}
with the (just for readability) substituted momenta
\begin{align}
 \tuple{\genMomentumSym}_{\v} &= m (\v - \wedOp(\bodyCOM{}{}) \w), 
\\
 \tuple{\genMomentumSym}_{\w} &= m \wedOp(\bodyCOM{}{}) \v + \bodyMOI{}{}{} \w + \JAC \mat{H}_1 \dot{\tuple{\PropTilt}}  + \JP \mat{H}_3(\tuple{\PropTilt}) \diag(\tuple{\PropDir}) \tuple{\PropVel}.
\end{align}
and the sub-matrices
\begin{align}
 \mat{H}_1 &= \begin{bmatrix}
  \cArmAngle[1] & \cdots & \cArmAngle[\numProp] \\
  \sArmAngle[1] & \cdots & \sArmAngle[\numProp] \\
  0 & \cdots & 0
 \end{bmatrix}\!,&
 \mat{H}_2(\tuple{\PropTilt}) &= \begin{bmatrix}
  \cArmAngle[1] \sPropTilt[1] & \cdots & \cArmAngle[\numProp] \sPropTilt[\numProp] \\
  \sArmAngle[1] \sPropTilt[1] & \cdots & \sArmAngle[\numProp] \sPropTilt[\numProp] \\
  0 & \cdots & 0
 \end{bmatrix}\!,
\\
 \mat{H}_3(\tuple{\PropTilt}) &= \begin{bmatrix}
   \sArmAngle[1] \sPropTilt[1] & \cdots &  \sArmAngle[\numProp] \sPropTilt[\numProp] \\
  -\cArmAngle[1] \sPropTilt[1] & \cdots & -\cArmAngle[\numProp] \sPropTilt[\numProp] \\
   \cPropTilt[1]               & \cdots &  \cPropTilt[\numProp]                     
 \end{bmatrix}\!,&
 \mat{H}_4(\tuple{\PropTilt}) &= \begin{bmatrix}
  \sArmAngle[1] \cPropTilt[1] & \cdots & \sArmAngle[\numProp] \cPropTilt[\numProp] \\
  -\cArmAngle[1] \cPropTilt[1] & & -\cArmAngle[\numProp] \cPropTilt[\numProp] \\
  -\sPropTilt[1] & \cdots & -\sPropTilt[\numProp]
 \end{bmatrix}
% \quad \tdiff{t} \big( \mat{H}_3(\tuple{\PropTilt}) \big) = \mat{H}_3'(\tuple{\PropTilt}) \diag(\dot{\tuple{\PropTilt}})
.
\end{align}
\end{subequations}

\paragraph{Tricopter.}
To get the rigid body model equations for the tricopter (displayed in \autoref{fig:TricopterInputs}) we plug the following parameters into \eqref{eq:RealizationMulticopterForces}
\begin{align}
 \numProp = 3,
\qquad
%  \ArmAngle[1] = \tfrac{\pi}{3}, \
%  \ArmAngle[2] = \pi, \
%  \ArmAngle[3] = -\tfrac{\pi}{3},
 \ArmAngle = \tfrac{\pi}{3} [1, 3, 5]^\top,
\qquad
%  \PropDir[1] = -1, \
%  \PropDir[2] = \PropDir[3] = 1.
 \PropDir = [-1, +1, +1]^\top.
\end{align}
The model equations do not simplify too much and the special result is not displayed explicitly here.

\paragraph{Quadcopter.}
For the quadcopter model we have the parameters (see \autoref{fig:QuadcopterInputs})
\begin{align}
 \numProp = 4,
\qquad
%  \ArmAngle[1] = 0, \
%  \ArmAngle[2] = \tfrac{\pi}{2}, \
%  \ArmAngle[3] = \pi, \
%  \ArmAngle[4] = -\tfrac{\pi}{2},
 \ArmAngle = \tfrac{\pi}{2} [0, 1, 2, 3]^\top,
\qquad
%  \PropDir[1] = \PropDir[3] = 1, \
%  \PropDir[2] = \PropDir[4] = -1,
 \tuple{\PropDir} = [+1, -1, +1, -1]^\top,
\qquad
% \PropTilt[1] = \PropTilt[2] = \PropTilt[3] = \PropTilt[4] = 0.
 \PropTilt = [0, 0, 0, 0]^\top.
\end{align}
Here the model equations simplify significantly:
Since the propellers do not tilt $\PropTilt = 0$, the corresponding equations can be regarded as definition of reaction torques $\ServoTorque$ and dropped from the model equations.
Overall the model for the quadcopter is
\begin{subequations}
\begin{align}
 \sysInertiaMat &=
 \begin{bmatrix}
  \m \idMat[3] & -\m \wedOp(\bodyCOM{}{}) & 0 \\
  \m \wedOp(\bodyCOM{}{}) & \bodyMOI{}{}{} & \JP \mat{H}_3 \diag(\tuple{\PropDir})\\
  0 & \PropInertia \diag(\tuple{\PropDir}) \mat{H}_3^\top & \PropInertia \idMat[4] \\
 \end{bmatrix},
\\
 \gyroForce(\sysVel) &= 
 \begin{bmatrix} \wedOp(\w) & 0 & 0 \\ \wedOp(\v) & \wedOp(\w) & 0 \\ 0 & 0 & 0 \end{bmatrix}
 \sysInertiaMat \sysVel,
\qquad
 \genForceGravity(\R) = \begin{bmatrix} \m \idMat[3] \\ \m \wedOp(\bodyCOM{}{}) \\ 0 \end{bmatrix} \RT (-\gravityAcc),
\\
 \genForceProp(\tuple{\PropVel}) &= \begin{bmatrix} \kappaF \mat{H}_3 \\ \kappaF \ArmRadius \mat{H}_4 - \kappaT \mat{H}_3 \diag(\tuple{\PropDir})  \\ -\kappaT \idMat[4]  \end{bmatrix} \diag(\tuple{\PropVel}) \tuple{\PropVel},
\qquad
 \genForceInput(\BLDCTorque) = \begin{bmatrix} 0 \\ 0 \\ \BLDCTorque \end{bmatrix}
\end{align}
with the sub-matrices
\begin{align}
 \mat{H}_3 &= \begin{bmatrix}
  0 & 0 & 0 & 0 \\
  0 & 0 & 0 & 0 \\
  1 & 1 & 1 & 1
 \end{bmatrix}\!,&
 \mat{H}_4 &= \begin{bmatrix}
  0 & 1 & 0 & -1 \\
  -1 & 0 & 1 & 0 \\
  0 & 0 & 0 & 0
 \end{bmatrix}\!.
\end{align}
\end{subequations}
Note that the system inertia matrix $\sysInertiaMat$ is constant, but there is still an inertial coupling between the propeller velocities $\tuple{\PropVel}$ and $\wz$.
The same model up to different dissipative forces, requiring $\bodyCOM{}{}{}=\tuple{0}$ and using Euler angles, has been derived in \cite{Martin:AccelerometerFeedback}.
%Also \cite{Mahony:Quadrotor2002} proposes a similar model, requiring $\bodyCOM{}{}{}=\tuple{0}$ and dropping some of the gyroscopic terms within $\gyroForce$.

\begin{figure}[ht]
 \centering
 \input{graphics/QuadcopterInputs.pdf_tex}
 \caption{Propeller forces on the Quadcopter}
 \label{fig:QuadcopterInputs}
\end{figure}


\subsection{Parameter identification}
The preceding mathematical model for the multicopters contains various constant parameters of which only the total mass $\m$ and the arm radius $\ArmRadius$ can be measured directly.
Some crucial parameters are identified in dedicated experimental setups which will be discussed in the following.
The remaining parameters are estimated by the method of least squares based on the system model and actual in-flight measurements.

%As mentioned before the overall rigid body system has a constant total mass $\m \in \RealNum$, combined center of mass $\bodyCOM{}{}{} \in \RealNum^3$ and combined moment of inertia $\bodyMOI{}{}{}=\bodyMOI{}{}{}^\top \in\RealNum^{3\times3}$.

\paragraph{Propeller and servo drive.}
For the identification of the propeller drive and its tilting mechanism we use a dedicated test bench, see \autoref{fig:PropellerTestBench}.
It is essentially one tricopter arm with additional absolute encoder for the tilt angle $\PropTilt$ and an incremental encoder for the propeller velocity $\PropVel$.

\begin{figure}
 \centering
 \includegraphics[width=.6\linewidth]{PropellerTestBench.jpg}
 \caption{Test bench for the propeller and tilting mechanism}
 \label{fig:PropellerTestBench}
\end{figure}
 
The equations of motion for the test bench are
\begin{align}
 \PropVeld + \underbrace{\tfrac{\kappaT}{\JP}}_{\PropParam[1]} \PropVel^2 &= \underbrace{\tfrac{\BLDCTorqueConstant}{\JP}}_{\PropParam[2]} \BLDCCurr + \underbrace{\tfrac{\BLDCFriction}{\JP}}_{\PropParam[3]}
\\
 \aServodd + \underbrace{\tfrac{\ServoKD}{\JA}}_{\ServoParam[1]} \aServod + \underbrace{\tfrac{\ServoKP}{\JA}}_{\ServoParam[0]} \aServo &= \underbrace{\tfrac{\ServoKP}{\JA}}_{\ServoParam[0]} \aServoU
\end{align}
The equations are normalized, yielding the parameters $\PropParam[1]$, $\PropParam[2]$, $\PropParam[3]$ and $\ServoParam[0]$, $\ServoParam[1]$, which will become more convenient later.
These parameters can be directly estimated from measured timeseries using Savitzky-Golay derivative estimation and the method of least squares.
The inertia parameters $\JP$ and $\JA$ are computed from a detailed CAD model of the multicopters.
With them one could recover the original parameters $\kappaT$, $\ServoKP$, etc.. 
The identified parameter values are summarized in \autoref{tab:ParamTriQuad}.

The accuracy of the proposed model and its identified parameters can be seen from the results in \autoref{fig:ServoSimRes} and \autoref{fig:PropCtrlRes} in \autoref{sec:RealizationForceVectorControl}.
An online estimation of the bias parameter $\PropParam[3]$ by means of an observer will be discussed there as well.

\paragraph*{Propeller thrust.}
For identification of the thrust constant $\kappaF$, a propeller drive was mounted horizontally on a $1\,\unit{m}$ tall pole.
The pole in turn stands on a digital scale and the ``weight'' was recorded at different propeller speeds $\PropVel$.
From this ``weight'' we can compute the corresponding propeller thrust $\PropForce$.
The measurements are displayed in \autoref{fig:PropVel2Thrust} together with the model $\PropForce = \kappaF \PropVel^2$ with the identified parameter value $\kappaF = 1.44 \cdot 10^{-5}\,\unit{N}\,\unit{s}^2$.

\begin{figure}
 \centering
 \footnotesize%
 \appendtographicspath{{graphics/PropVel2Thrust/}}%
 \input{graphics/PropVel2Thrust/PropVel2Thrust.tex}%
 \caption{Measured propeller thrust compared to proposed model}
 \label{fig:PropVel2Thrust}
\end{figure}

\paragraph*{Rigid body inertia.}
A dedicated experiment was conducted for identification of the inertia parameters $\Jxx$, $\Jyy$ and $\Jzz$ for quad and tricopter.
The body is suspended by two strings as shown on the left side of \autoref{fig:QuadPendulumIdent}.
The basic idea is that a rotation of the body about the vertical axis results in a upward movement of the body which is countered by gravity.
So we basically have a torsional spring, which, together with the inertia forms an oscillator whose frequency is proportional to the moment of inertia.

\begin{figure}
 \centering
 \input{graphics/QuadPendulumIdent.pdf_tex}
 \hfill
 \footnotesize%
 \appendtographicspath{{graphics/PendulumIdentRes/}}%
 \input{graphics/PendulumIdentRes/PendulumIdentRes.tex}%
 \caption{Experimental setup and identification result for $\Jxx$ of the Quadcopter}
 \label{fig:QuadPendulumIdent}
\end{figure}

The equation of motion for the vertical rotation with angle $\alpha$ in this setup is
\begin{align}\label{eq:PendulumIdent}
 \bodyMOISym \ddot{\alpha} + \bodyMODSym \dot{\alpha} + \m \gravityAccConst \frac{d^2 \sin\alpha}{4\sqrt{h^2 - \tfrac{d^2}{2}(1-\cos\alpha)}} = 0.
\end{align}
Here $\m$ indicated the total mass of the copter, $\gravityAccConst = 9.81\,\sfrac{\unit{m}}{\unit{s}^2}$ is the gravitational acceleration, $d$ and $h$ are the distance and length of the strings.
From the measured trajectory $t\mapsto\alpha$ of the twist angle we can estimate the inertia $\bodyMOISym$ and damping $\bodyMODSym$ about the corresponding axis.

On the right side of \autoref{fig:QuadPendulumIdent}, the acceleration $\ddot{\alpha}$ computed from the model \eqref{eq:PendulumIdent} with the estimated parameters is plotted against the measured acceleration, computed from the onboard gyroscope readings.

This test was conducted for all three axis, i.e.\ for $\Jxx$, $\Jyy$ and $\Jzz$ for Tri- and Quadcopter and the resulting parameters are given in \autoref{tab:ParamTriQuad}.
The identified parameters match the values computed from a detailed CAD model by $\pm 10\%$.

\paragraph*{Parameter identification from flight test.}
The model \eqref{eq:RealizationMulticopterKinetics} still contains several so far unknown parameters:
The coordinates of the center of mass $\bodyCOM{}{}{} = [\sx, \sy, \sz]^\top$, the off-diagonal entries $\Jxy$, $\Jxz$ and $\Jyz$, the translational damping $\dvx$, $\dvz$, the rotational damping $\sigx$, $\sigz$ and the coordinate $\lz$ of the center of damping.

With some auxiliary transformation ($\lzp = \dvx\lz$, $\sigxp = \sigx + \dvz\lz^2$) the first 6 model equations \eqref{eq:RealizationMulticopterKinetics} are linear in the remaining unknown parameters.
So we can identify these by the method of least squares from flight test measurements.
\autoref{tab:ParamTriQuad} summarizes the identified parameter values from this flight test as well as the ones from the previously discussed dedicated experiments.
These are the values that are used for the simulator.

From this experiment we have the first estimate for the overall center of mass $\bodyCOM{}{}{}$ of tri- and quadcopter.
The identified value $\sz$ is then used to adjust the body fixed frame in the vertical direction such that $\sz=0\,\unit{m}$.
For the Tricopter this determines also the parameter $\ArmHeight$.
The values for $\sx$ and $\sy$ are small so we stick to the geometric center in the horizontal directions.

The damping parameter values for the tricopter are greater than the ones for the quadcopter.
This could be explained by the model from \cite{Martin:AccelerometerFeedback} and the fact that the propellers of the Tricopter nominally spin $40\%$ faster than on the Quadcopter.
Also the identified value for $\lz$ is roughly the distance from the body fixed frame to the propeller plane which fits well to their model.
On the other hand, the identified translational damping $\dvz$ in the vertical direction is greater than the horizontal damping $\dvx$.
This contradicts the model proposed in \cite{Martin:AccelerometerFeedback} which would imply $\dvz = 0$.

\autoref{tab:ParamTriQuad} also shows identified constant bias forces $\FB$ and torques $\tauB$ for this particular experiment.
These mean values probably result from small misalignments of the propellers and servos rather than constant side wind or anything similar.
In the practical application the bias forces will be estimated online by means of an observer, so can vary slowly.
However, the magnitudes of the displayed identified values are less than $3\%$ compared to the maximal available propeller forces $\genForceProp$ in the corresponding directions, so their influence on the overall identification result should be small.



% The scalar inertia parameters
% \begin{align}
%  \JA &= \bodyMOISym_{\mathsf{Axx}} + c_{\mathsf{S}}^2 \bodyMOISym_{\mathsf{Sxx}},&
%  \JAC &= \bodyMOISym_{\mathsf{Axx}} + c_{\mathsf{S}} \bodyMOISym_{\mathsf{Sxx}},&
% % \JP &= \bodyMOISym_{\mathsf{Pzz}},&
% \end{align}
% are related to the tilting mechanism.
% Here $\bodyMOISym_{\mathsf{Axx}}$ is the moment of inertia of the arm about the tilt axis and $\bodyMOISym_{\mathsf{Sxx}}$ the inertia of the servo motor rotor.
% What is important here is that $\JA$ and $\JAC$ take different values which would not be the case if one would not model the servo motor properly.
% For the Tricopter the estimated values are $\JA = 0.89\,\unit{kg}\,\unit{m}^2$ and $\JAC = 0.0015\,\unit{kg}\,\unit{m}^2$ which should emphasize the importance.
% 
% The remaining parameters in \eqref{eq:RealizationMulticopterKinetics} are the distances $\ArmRadius$ and $\ArmHeight$, see \autoref{fig:TricopterInputs}, the aerodynamics propeller parameters $\kappaF$ and $\kappaT$, the propeller spinning directions $\PropDir[k] = \pm 1$ and the gravity coefficients $\gravityAcc \in \RealNum^3$.
% The inertial frame was chosen to be aligned with the gravity direction, \ie $\gravityAcc = [0,0,-9.81]^\top \sfrac{\unit{m}}{\unit{s}^2}$.


\begin{table}
 \centering
 \setlength{\tabcolsep}{.1em}
 \begin{tabular}{crlrll}
  \toprule
  symbol & \multicolumn{2}{c}{tricopter value} & \multicolumn{2}{c}{quadcopter value} & \multicolumn{1}{c}{source} \\
  \midrule
  $\quad\m\quad$ & $1.251$&$\unit{kg}$ & $1.001$&$\unit{kg}$ & directly measured
  \\[1ex]
  $\sx$ & $ 1.7 \cdot 10^{-3}$&$\unit{m}$ & $ -1.8 \cdot 10^{-3}$&$\unit{m}$ & flight test \\
  $\sy$ & $ 0.6 \cdot 10^{-3}$&$\unit{m}$ & $ 0.6 \cdot 10^{-3}$&$\unit{m}$ & flight test \\
  $\sz$ & $ 0.0 \cdot 10^{-3}$&$\unit{m}$ & $ 0.0 \cdot 10^{-3}$&$\unit{m}$ & manually adjusted
  \\[1ex]
  $\Jxx$ & \phantom{|} \qquad $19.2 \cdot 10^{-3}$&$\unit{kg}\,\unit{m}^2$ \qquad \phantom{|} & \phantom{|} \qquad $17.9 \cdot 10^{-3}$&$\unit{kg}\,\unit{m}^2$ \qquad \phantom{|} & pendulum test\\
  $\Jyy$ & $19.2 \cdot 10^{-3}$&$\unit{kg}\,\unit{m}^2$ & $18.0 \cdot 10^{-3}$&$\unit{kg}\,\unit{m}^2$ & pendulum test \\
  $\Jzz$ & $30.8 \cdot 10^{-3}$&$\unit{kg}\,\unit{m}^2$ & $30.7 \cdot 10^{-3}$&$\unit{kg}\,\unit{m}^2$ & pendulum test \\
  $\Jxy$ & $-0.8 \cdot 10^{-3}$&$\unit{kg}\,\unit{m}^2$ & $-0.7 \cdot 10^{-3}$&$\unit{kg}\,\unit{m}^2$ & flight test \\
  $\Jxz$ & $-1.2 \cdot 10^{-3}$&$\unit{kg}\,\unit{m}^2$ & $ 0.2 \cdot 10^{-3}$&$\unit{kg}\,\unit{m}^2$ & flight test \\
  $\Jyz$ & $-2.1 \cdot 10^{-3}$&$\unit{kg}\,\unit{m}^2$ & $ 0.0 \cdot 10^{-3}$&$\unit{kg}\,\unit{m}^2$ & flight test 
  \\[1ex]
  $\dvx$ & $0.29 $&$\sfrac{\unit{kg}}{\unit{s}}$ & $0.30 $&$\sfrac{\unit{kg}}{\unit{s}}$ & flight test \\
  $\dvz$ & $0.45 $&$\sfrac{\unit{kg}}{\unit{s}}$ & $0.36 $&$\sfrac{\unit{kg}}{\unit{s}}$ & flight test \\
  $\lz$ & $4.0 \cdot 10^{-3}$&$\unit{m}$ & $12 \cdot 10^{-3}$&$\unit{m}$ & flight test \\
  $\sigx$ & $8.5 \cdot 10^{-3}$&$\sfrac{\unit{kg}\,\unit{m}^2}{\unit{s}}$ & $-1.5 \cdot 10^{-3}$&$\sfrac{\unit{kg}\,\unit{m}^2}{\unit{s}}$ & flight test \\
  $\sigz$ & $14 \cdot 10^{-3}$&$\sfrac{\unit{kg}\,\unit{m}^2}{\unit{s}}$ & $10 \cdot 10^{-3}$&$\sfrac{\unit{kg}\,\unit{m}^2}{\unit{s}}$ & flight test
  \\[1ex]
  $\gravityAcc$ & \multicolumn{4}{c}{$[0, 0, -9.81]^\top \sfrac{\unit{m}}{\unit{s}^2}$} & 
  \\[1ex]
  $\ArmRadius$ & $ 240 \cdot 10^{-3}$&$\unit{m}$ & $240 \cdot 10^{-3}$&$\unit{m}$ & directly measured \\
  $\ArmHeight$ & $  -6 \cdot 10^{-3}$&$\unit{m}$ & \multicolumn{2}{c}{-} & manually adjusted
  \\[1ex]
  $\JA$  & $ 0.9$&$\unit{kg}\,\unit{m}^2$ & \multicolumn{2}{c}{-} & CAD model \\
  $\JAC$ & $ 0.002$&$\unit{kg}\,\unit{m}^2$ & \multicolumn{2}{c}{-} & prop. test bench \\
  $\ServoKP$ & $ 1400 $&$\unit{Nm}\,\unit{s}^2$ & \multicolumn{2}{c}{-} & prop. test bench\\
  $\ServoKD$ & $ 66$&$\unit{Nm}\,\unit{s}$ & \multicolumn{2}{c}{-} & prop. test bench
  \\[1ex] 
  $\JP$  & \multicolumn{4}{c}{$3.6 \cdot 10^{-5}\,\unit{kg}\,\unit{m}^2$} & CAD model \\
  $\kappaF$ & \multicolumn{4}{c}{$1.44 \cdot 10^{-5}\,\unit{N}\,\unit{s}^2$} & prop. test bench \\
  $\kappaT$ & \multicolumn{4}{c}{$2.45 \cdot 10^{-7}\,\unit{N}\unit{m}\,\unit{s}^2$} & prop. test bench \\
  $\BLDCTorqueConstant$ & \multicolumn{4}{c}{$0.0105\,\sfrac{\unit{N}\unit{m}}{\unit{A}}$} & prop. test bench \\
  $\BLDCFriction$ & \multicolumn{4}{c}{$0.005\,\unit{N}\unit{m}$} & prop. test bench
  \\[1ex]
  $\FBx$ & $-0.21$&$\unit{N}$ & $ 0.09$&$\unit{N}$ & flight test \\
  $\FBy$ & $-0.02$&$\unit{N}$ & $ 0.02$&$\unit{N}$ & flight test \\
  $\FBz$ & $ 0.03$&$\unit{N}$ & $ -0.09$&$\unit{N}$ & flight test \\
  $\tauBx$ & $ 0.037$&$\unit{N}\unit{m}$ & $ 0.049$&$\unit{N}\unit{m}$ & flight test \\
  $\tauBy$ & $-0.024$&$\unit{N}\unit{m}$ & $-0.015$&$\unit{N}\unit{m}$ & flight test \\
  $\tauBz$ & $-0.003$&$\unit{N}\unit{m}$ & $-0.012$&$\unit{N}\unit{m}$ & flight test \\
  \bottomrule
 \end{tabular}
 \caption{Parameter values for tri- and quadcopter model}
 \label{tab:ParamTriQuad}
\end{table}

\clearpage
\subsection{Model validation and simplification}
In the previous subsections we proposed a quite detailed model for tri- and quadcopter.
Now we like to validate this model by comparing it to experimental data.
From this quantitative analysis we can also motivate which parts of the model can be neglected to obtain a simplified model that is still accurate enough for our working domain.

\paragraph*{Tricopter.}
\autoref{fig:ValidationTricopter} shows the accelerations $\sysVeld$ during a benchmark fight test for the tricopter.
The data corresponds to a $20\,\unit{s}$ sample at the beginning of the video available here\footnote{\url{https://youtu.be/oS5PHr6H0K4}}.
The gray lines are obtained by applying a Savitzky-Golay derivative filter to the measured generalized velocities $\sysVel$.
The blue lines are the accelerations $\sysVeld$ computed from the model \eqref{eq:RealizationMulticopterKinetics} with the parameters from \autoref{tab:ParamTriQuad} and the measured configuration, velocity and inputs.
The dashed red lines are the accelerations computed in the same way but from a simplified model that will be proposed now:

\begin{figure}[p]
 \centering
 \footnotesize%
 \appendtographicspath{{graphics/ModelValidationTri/}}
 \input{graphics/ModelValidationTri/ModelValidationTri.tex}
 \vspace{-20pt}
 \caption{Model vs. measured accelerations for the tricopter}
 \label{fig:ValidationTricopter}
\end{figure}

For the simplified model of the tricopter we drop all off diagonal entries in the system inertia matrix $\sysInertiaMat$.
This means in particular $\bodyCOM{}{}{} = 0$ and $\bodyMOI{}{}{} = \diag(\Jx, \Jy, \Jz)$.
Furthermore we drop the damping parameters $\lz=0$, $\sigx=\sigz=0$ and assume isotropic translational damping $D_v = \DampingSym \idMat[3]$ with $\DampingSym = \tfrac{1}{3}(2\dvx + \dvz)$.
The resulting model equations are summarized as follows:

\begin{RedBox}
\textbf{Simplified tricopter model.}
Rigid body dynamics
\begin{subequations}\label{eq:TricopterSimpModel}
\begin{align}
 \rd &= \R\, \v,&
 \m(\vd + \wedOp(\w)\v - \RT \gravityAcc) + \bodyDamping{}{} \v &= \F + \FB,
% \FBd &= 0,
\\
 \Rd &= \R \wedOp(\w),&
 \J \dot{\w} + \wedOp(\w) \J \w &= \tau + \tauB,
% \tauBd &= 0
\end{align}
Generalized force from propellers
\begin{align}\label{eq:TriActuatorTrafo}
 \underbrace{\begin{bmatrix}[1.2] \Fx \\ \Fy \\ \Fz \\ \taux \\ \tauy \\ \tauz \end{bmatrix}}_{\genForce}
 =
 \underbrace{\begin{bmatrix}[1.1] 
  0 & 0 & 0 & \tfrac{\sqrt{3}}{2} & 0 & -\tfrac{\sqrt{3}}{2} \\
  0 & 0 & 0 & -\tfrac{1}{2} & 1 & -\tfrac{1}{2} \\
  1 & 1 & 1 & 0 & 0 & 0 \\
   \tfrac{\sqrt{3}\,\ArmRadius}{2} & 0 & -\tfrac{\sqrt{3}\,\ArmRadius}{2} & \tfrac{\ArmHeight}{2} + \tfrac{\sqrt{3}\,\kappaT}{2\,\kappaF} & \ArmHeight & \tfrac{\ArmHeight}{2} + \tfrac{\sqrt{3}\,\kappaT}{2\,\kappaF} \\
  -\tfrac{\ArmRadius}{2} & \ArmRadius & -\tfrac{\ArmRadius}{2} & \tfrac{\sqrt{3}\,\ArmHeight}{2} - \tfrac{\kappaT}{2\,\kappaF} & \tfrac{\kappaT}{\kappaF} & \tfrac{\kappaT}{2\,\kappaF} - \tfrac{\sqrt{3}\,\ArmHeight}{2} \\
  \tfrac{\kappaT}{\kappaF} & -\tfrac{\kappaT}{\kappaF} & -\tfrac{\kappaT}{\kappaF} & -\ArmRadius & -\ArmRadius & -\ArmRadius
 \end{bmatrix}}_{B}
 \underbrace{\begin{bmatrix}[1.2] \F^{\mathsf{V}}_1 \\ \F^{\mathsf{V}}_2 \\ \F^{\mathsf{V}}_3 \\ \F^{\mathsf{H}}_1 \\ \F^{\mathsf{H}}_2 \\ \F^{\mathsf{H}}_3 \end{bmatrix}}_{\F^\mathsf{VH}}
\\
 \F^{\mathsf{V}}_j = \PropForce[j] \cos\aServo[j], 
 \quad
 \F^{\mathsf{H}}_j = \PropForce[j] \sin\aServo[j],
 \quad
 \PropForce[j] = \kappaF \PropVel[j]^2, \qquad j=1,2,3
\end{align}
Propeller drive dynamics
\begin{align}
 \PropInertia \PropVeld[j] + \kappaT \PropVel[j]^2 = \BLDCTorqueConstant[j] \BLDCCurr[j] - \BLDCFriction[j], \qquad j=1,2,3
% \PropVeld[j] + \PropParam[1] \PropVel[j]^2 = \PropParam[2] \BLDCCurr[j] - \PropParam[3], \qquad j=1,2,3.
\end{align}
Servo dynamics
\begin{align}\label{eq:TriModelServoDynamics}
 \aServodd[j] + \ServoParam[1] \aServod[j] + \ServoParam[0] \aServo[j] = \ServoParam[0] \aServoU[j], \qquad j=1,2,3
\end{align}

\end{subequations}
\end{RedBox}

Comparing the computed accelerations flight test in \autoref{fig:ValidationTricopter} one finds the following observations: % that the simplified model is as good or bad as the full model.
For the translational $\vxd$, $\vzd$ and the propeller acceleration $\PropVeld[1]$ the two models can not be distinguished and they match the measured accelerations quite well.
For the angular accelerations $\wxd$ and $\wzd$ the models differ slightly.
Unfortunately, one cannot say that the full model matches the measured accelerations better than the simplified.
This means that there are unmodeled effects that have a greater influence than the ones we dropped for the simplified model.
Overall the simplified model \eqref{eq:TricopterSimpModel} captures the Tricopter dynamics reasonably well and is due to its simplicity a good starting point for the model based control design.

\paragraph*{Quadcopter.}
As simplifications for the quadcopter model we neglect the inertial couplings between the center body and propeller except $\PropInertia \mat{H}_1 \PropVeld$.
Furthermore, we assume $\bodyCOM{}{}{} = 0$ and $\bodyMOI{}{}{} = \diag(\Jx, \Jx, \Jz)$.
The resulting model reads:

\begin{RedBox}
\textbf{Simplified quadcopter model.}
Rigid body dynamics
\begin{subequations}\label{eq:QuadcopterSimpModel}
\begin{align}
 \rd &= \R\, \v,&
 \m(\vd + \wedOp(\w)\v - \RT \gravityAcc) + \bodyDamping{}{} \v &= \Fz e_3 + \FB,
% \FBd &= 0,
\\
 \Rd &= \R \wedOp(\w),&
 \J \dot{\w} + \wedOp(\w) \J \w &= \tau + \tauB,
% \tauBd &= 0
\end{align}
Generalized force from propeller rotation
\begin{align}\label{eq:QuadActuatorTrafo}
 \begin{bmatrix} \Fz \\ \taux \\ \tauy \\ \tauz \end{bmatrix}
 =
 \underbrace{\begin{bmatrix}
  1 & 1 & 1 & 1 \\
  0 & \ArmRadius & 0 & -\ArmRadius \\
  -\ArmRadius & 0 & \ArmRadius & 0 \\
  -\tfrac{\kappaT}{\kappaF} & \tfrac{\kappaT}{\kappaF} & -\tfrac{\kappaT}{\kappaF} & \tfrac{\kappaT}{\kappaF} \\
 \end{bmatrix}}_{\mat{B}}
 \underbrace{\begin{bmatrix} \kappaF \PropVel[1]^2 \\ \kappaF \PropVel[2]^2 \\ \kappaF \PropVel[3]^2 \\ \kappaF \PropVel[4]^2 \end{bmatrix}}_{\tuple{\PropForce[]}}
 -
 \begin{bmatrix} 0 \\ 0 \\ 0 \\ \JP (\PropVeld[1] - \PropVeld[2] + \PropVeld[3] - \PropVeld[4]) \end{bmatrix}
\end{align}
Propeller drive dynamics
\begin{align}\label{eq:QuadPropDynamics}
 \PropInertia \PropVeld[j] + \kappaT \PropVel[j]^2 = \BLDCTorqueConstant[j] \BLDCCurr[j] - \BLDCFriction[j], \qquad j=1,\ldots,4.
\end{align}
\end{subequations}
\end{RedBox}

Up to a change in velocity coordinates this model is identical to the one proposed in \cite[eq.\ 7--12]{Mahony:Quadrotor2002}.

\begin{figure}[p]
 \centering
 \footnotesize%
 \appendtographicspath{{graphics/ModelValidationQuad/}}
 \input{graphics/ModelValidationQuad/ModelValidationQuadMOD.tex}
 \vspace{-20pt}
 \caption{Model vs.\ measured accelerations on the quadcopter}
 \label{fig:ValidationQuadcopter}
\end{figure}

As discussed above for the tricopter, the validation result for the quadcopter is shown in \autoref{fig:ValidationQuadcopter} which is the first $20\,\unit{s}$ from \url{https://youtu.be/x66sua3M6RQ}.
The full model and simplified model can hardly be distinguished, so one may say that the simplifications are justified.
The measured translational accelerations and the propeller acceleration fit the model quite well.
For the angular accelerations there are slightly varying offsets between model and measurements.
These are probably aerodynamic disturbances rather than mechanical modeling errors.
Nevertheless, this motivates the use of a disturbance observer which will be discussed in a following section.

In contrast to the tricopter simplifications, the simplified quadcopter model did not drop the inertial coupling between the propellers and the yaw dynamics.
The reason for this is twofold:
The tricopter may generate yaw torque by tilting the propellers, whereas the quadcopter relies on the propeller drag and the inertial coupling, which are nominally much smaller.
Secondly, the experiments with the quadcopter perform much more dynamic maneuvers which result in higher propeller accelerations as can be seen exemplary by comparing \autoref{fig:ValidationQuadcopter} to \autoref{fig:ValidationTricopter}.
